<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evoluci√≥n Artificial ‚Äì MVP (Vanilla JS)</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#0b1222;
      --panel2:#111827; /* slate-800 */
      --text:#e5e7eb; /* slate-200 */
      --muted:#94a3b8; /* slate-400 */
      --brand:#6366f1; /* indigo-500 */
      --ok:#10b981; /* emerald-500 */
      --blue:#3b82f6; /* blue-500 */
      --rose:#f43f5e; /* rose-500 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .header{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:rgba(15,23,42,.9);backdrop-filter:blur(6px);border-bottom:1px solid #0b1222}
    .muted{color:var(--muted)}
    .main{display:grid;grid-template-columns:1fr 360px;gap:16px;padding:12px}
    @media (max-width: 1024px){.main{grid-template-columns:1fr}}
    .canvas-pane{position:relative;min-height:62vh;height:78vh;border:1px solid #0b1222;border-radius:16px;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.3)}
    canvas{width:100%;height:100%;display:block;cursor:crosshair}
    .btn{background:rgba(30,41,59,.8);color:var(--text);border:none;border-radius:12px;padding:8px 12px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .btn:hover{background:#334155}
    .btn-primary{background:var(--brand)}.btn-primary:hover{background:#7c82f7}
    .hud{position:absolute;left:8px;top:8px;display:flex;gap:8px;align-items:center}
    .stats{position:absolute;right:8px;top:8px;font-size:12px;color:#d1d5db;background:rgba(30,41,59,.7);border-radius:12px;padding:3px 8px;box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .dock{position:absolute;left:8px;bottom:8px;background:rgba(30,41,59,.6);border-radius:12px;padding:8px 10px;display:flex;gap:16px;align-items:center}
    .control-pane{position:sticky;top:56px;align-self:start;display:flex;flex-direction:column;gap:12px}
    .card{background:rgba(17,24,39,.7);border:1px solid #0b1222;border-radius:16px;padding:12px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .card h3{margin:0 0 8px 0;font-size:14px}
    .row{display:flex;justify-content:space-between;align-items:center;font-size:12px;margin-bottom:6px}
    .range{width:100%}
    details{margin-top:6px}
    .grid-hint{position:absolute;inset:0;pointer-events:none}
  </style>
</head>
<body>
  <header class="header">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="font-weight:700;font-size:18px">Evoluci√≥n Artificial üß¨</div>
      <div class="muted" style="font-size:13px">Criaturas que aprenden a llegar al objetivo</div>
    </div>
    <div class="muted" style="font-size:12px;display:none" id="hint-lg">Shift+arrastrar = obst√°culo ¬∑ Alt+click = borrar obst√°culo ¬∑ Arrastr√° el objetivo</div>
  </header>

  <main class="main">
    <section class="canvas-pane" id="canvas-pane">
      <canvas id="sim"></canvas>
      <div class="hud">
        <button id="btn-toggle" class="btn">Pausar</button>
        <button id="btn-reset" class="btn">Reset</button>
        <button id="btn-next" class="btn btn-primary">Forzar nueva gen</button>
      </div>
      <div class="stats" id="stats">‚Äî</div>
      <div class="dock">
        <label class="muted" style="display:flex;align-items:center;gap:8px;font-size:13px">
          <span>Velocidad</span>
          <input id="speed" class="range" type="range" min="1" max="12" step="1" value="1" />
        </label>
        <label class="muted" style="display:flex;align-items:center;gap:8px;font-size:13px">
          <span>Gravedad</span>
          <input id="gravity" class="range" type="range" min="0" max="220" step="10" value="0" />
        </label>
      </div>
    </section>

    <aside class="control-pane">
      <section class="card">
        <h3>Par√°metros gen√©ticos</h3>
        <div class="row"><span class="muted">Poblaci√≥n</span><span id="lbl-pop">200</span></div>
        <input id="populationSize" class="range" type="range" min="50" max="600" step="10" value="200" />
        <div class="row"><span class="muted">Pasos por genoma</span><span id="lbl-steps">320</span></div>
        <input id="geneSteps" class="range" type="range" min="120" max="600" step="10" value="320" />
        <div class="row"><span class="muted">Mutaci√≥n</span><span id="lbl-mutation">0.020</span></div>
        <input id="mutationRate" class="range" type="range" min="0" max="0.2" step="0.005" value="0.02" />
        <div class="row"><span class="muted">Elitismo</span><span id="lbl-elitism">4</span></div>
        <input id="elitism" class="range" type="range" min="0" max="20" step="1" value="4" />
        <div class="muted" style="font-size:12px;margin-top:6px">Cambiar poblaci√≥n o pasos reinicia la simulaci√≥n.</div>
      </section>
      <section class="card">
        <h3>Obst√°culos</h3>
        <div class="muted" style="font-size:13px">Shift+arrastrar para dibujar ¬∑ Alt+click para borrar</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btn-obs-clear" class="btn">Limpiar</button>
          <button id="btn-obs-rand" class="btn">Aleatorios</button>
        </div>
      </section>
      <section class="card">
        <h3>Ayuda</h3>
        <ul class="muted" style="font-size:13px;line-height:1.5">
          <li>Arrastr√° el objetivo (c√≠rculo verde).</li>
          <li>Forz√° una nueva generaci√≥n cuando quieras.</li>
          <li>Prob√° mutaci√≥n alta al inicio y reduc√≠ luego.</li>
        </ul>
      </section>
      <section class="card">
        <h3>Tests</h3>
        <details>
          <summary class="muted" style="cursor:pointer">Ver resultados en consola</summary>
          <div class="muted" style="font-size:12px">Se ejecutan al cargar (console.assert).</div>
        </details>
      </section>
    </aside>
  </main>

  <script>
  // ======= Utilidades =======
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  function randn(mu=0,sigma=1){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();const z=Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);return mu+z*sigma}
  function makeVec(){const a=Math.random()*Math.PI*2;const m=Math.random();return {ax:Math.cos(a)*m,ay:Math.sin(a)*m}}
  function createGenome(steps){return Array.from({length:steps},makeVec)}
  function cloneGenome(g){return g.map(v=>({ax:v.ax,ay:v.ay}))}
  function mutateGenome(g, rate, sigma=0.35){for(let i=0;i<g.length;i++){if(Math.random()<rate){const v=g[i];v.ax=clamp(v.ax+randn(0,sigma),-1,1);v.ay=clamp(v.ay+randn(0,sigma),-1,1);const m=Math.hypot(v.ax,v.ay);if(m>1){v.ax/=m;v.ay/=m}}}}
  function crossover(g1,g2){const out=new Array(g1.length);for(let i=0;i<g1.length;i++){out[i]=Math.random()<0.5?{...g1[i]}:{...g2[i]}}return out}
  function pickColor(i){const p=["#60a5fa","#22c55e","#f59e0b","#e879f9","#a78bfa","#34d399","#f97316","#fb7185"];return p[i%p.length]}
  function safeFmt(v,d=0){return (typeof v==='number' && Number.isFinite(v))? v.toFixed(d) : '‚Äî'}
  function formatBestDist(d){return Number.isFinite(d)? d.toFixed(1) : '‚àû'}

  // ======= Estado global =======
  const canvas = document.getElementById('sim');
  const pane = document.getElementById('canvas-pane');
  const statsEl = document.getElementById('stats');

  let running = true;
  let populationSize = 200;
  let geneSteps = 320;
  let mutationRate = 0.02;
  let elitism = 4;
  let speed = 1;       // steps por frame
  let gravity = 0;     // px/s^2

  let generation = 1;
  let stepIndex = 0;
  let bestDist = Infinity;
  let reachedCount = 0;

  const startPos = {x:80,y:520};
  const target = {x:700,y:100,r:14,dragging:false};
  let obstacles = [
    {x:180,y:380,w:360,h:12},
    {x:220,y:230,w:320,h:12},
  ];
  const drawing = {drawing:false,x0:0,y0:0};

  /** @type {Array<{x:number,y:number,vx:number,vy:number,alive:boolean,reached:boolean,step:number,genome:Array<{ax:number,ay:number}>,fitness:number,color:string,trail:Array<{x:number,y:number}>,trailAge:number}>} */
  let pop = [];

  // ======= Layout/resize =======
  function resize(){
    const rect = pane.getBoundingClientRect();
    let w = rect.width;
    let h = rect.height;
    // Fallback por si el contenedor todav√≠a no tiene layout (evita canvas 0x0)
    if (!w || !h || w < 100 || h < 100) {
      // fuerza un alto razonable y reintenta
      pane.style.minHeight = '640px';
      const r2 = pane.getBoundingClientRect();
      w = r2.width || 960;
      h = r2.height || 640;
      console.info('[Evo] Fallback de tama√±o aplicado', w, h);
    }
    const dpr = Math.min(window.devicePixelRatio||1,2);
    canvas.width = Math.floor(w*dpr);
    canvas.height = Math.floor(h*dpr);
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  new ResizeObserver(resize).observe(document.documentElement);
  resize();

  // ======= Seed / Evoluci√≥n =======
  function seedPopulation(genomes){
    pop.length = 0;
    for(let i=0;i<populationSize;i++){
      const genome = genomes? cloneGenome(genomes[i%genomes.length]) : createGenome(geneSteps);
      pop.push({x:startPos.x,y:startPos.y,vx:0,vy:0,alive:true,reached:false,step:0,genome,fitness:0,color:pickColor(i),trail:[],trailAge:0});
    }
    bestDist = Infinity; reachedCount = 0; stepIndex = 0;
  }

  function evolve(){
    // fitness y m√©trica
    let reached=0; let best=Infinity;
    for(const a of pop){
      const dx=a.x-target.x, dy=a.y-target.y; const dist=Math.hypot(dx,dy);
      if(a.reached){ a.fitness = 10000 + (geneSteps - a.step); reached++; }
      else { a.fitness = 1/(1+dist); }
      if(dist<best) best=dist;
    }
    bestDist = best; reachedCount = reached;

    // ruleta
    const totalFit = pop.reduce((s,a)=>s+a.fitness,0)||1;
    const pick = ()=>{ let r=Math.random()*totalFit; for(const a of pop){ r -= a.fitness; if(r<=0) return a;} return pop[pop.length-1] };

    // elitismo + reproducci√≥n
    const sorted = [...pop].sort((a,b)=>b.fitness-a.fitness);
    const next = [];
    for(let i=0;i<Math.min(elitism,sorted.length);i++) next.push(newAgentFromGenome(cloneGenome(sorted[i].genome)));
    while(next.length<populationSize){
      const p1=pick(), p2=pick();
      const child = crossover(p1.genome,p2.genome);
      mutateGenome(child,mutationRate);
      next.push(newAgentFromGenome(child));
    }
    pop = next; generation++; stepIndex=0;
  }

  function newAgentFromGenome(genome){
    return {x:startPos.x,y:startPos.y,vx:0,vy:0,alive:true,reached:false,step:0,genome,fitness:0,color:pickColor(Math.floor(Math.random()*99999)),trail:[],trailAge:0};
  }

  // ======= Sim =======
  let last = performance.now();
  let rafId = 0;
  function loop(){
    try{
      const now = performance.now();
      const dt = Math.min(0.04,(now-last)/1000); // clamp
      last = now;
      if(running){ for(let s=0;s<speed;s++) step(dt); }
      render();
      rafId = requestAnimationFrame(loop);
    }catch(err){
      console.error('[Evo] Loop error', err);
      cancelAnimationFrame(rafId);
      statsEl.textContent = 'Error: ' + (err && err.message ? err.message : err);
    }
  }
    render();
    requestAnimationFrame(loop);
  }

  function step(dt){
    const W = canvas.clientWidth, H = canvas.clientHeight;
    let allDone = true;
    for(const a of pop){
      if(!a.alive || a.reached) continue; allDone=false;
      const g = a.genome[a.step] || {ax:0, ay:0};
      const accel = 80;
      a.vx += g.ax*accel*dt;
      a.vy += (g.ay*accel + gravity)*dt;
      const vmax=240; const m=Math.hypot(a.vx,a.vy); if(m>vmax){ a.vx=(a.vx/m)*vmax; a.vy=(a.vy/m)*vmax; }
      a.x += a.vx*dt; a.y += a.vy*dt;
      // muros
      if(a.x<4||a.x>W-4||a.y<4||a.y>H-4){ a.alive=false; continue; }
      // obst√°culos
      for(const o of obstacles){ if(a.x>=o.x && a.x<=o.x+o.w && a.y>=o.y && a.y<=o.y+o.h){ a.alive=false; break; } }
      if(!a.alive) continue;
      // target
      const dx=a.x-target.x, dy=a.y-target.y; if(dx*dx+dy*dy<=target.r*target.r){ a.reached=true; }
      a.step++;
      a.trailAge++; if(a.trailAge%3===0){ a.trail.push({x:a.x,y:a.y}); if(a.trail.length>50) a.trail.shift(); }
      if(a.step>=geneSteps) a.alive=false;
    }
    stepIndex++;
    if(allDone || stepIndex>=geneSteps+2) evolve();
  }

  function render(){
    const ctx = canvas.getContext('2d');
    const w = canvas.clientWidth, h = canvas.clientHeight;
    ctx.clearRect(0,0,w,h);
    // grid
    ctx.save(); ctx.globalAlpha=.25; ctx.strokeStyle="#0f172a"; ctx.lineWidth=1;
    for(let x=0;x<w;x+=40){ ctx.beginPath(); ctx.moveTo(x+.5,0); ctx.lineTo(x+.5,h); ctx.stroke(); }
    for(let y=0;y<h;y+=40){ ctx.beginPath(); ctx.moveTo(0,y+.5); ctx.lineTo(w,y+.5); ctx.stroke(); }
    ctx.restore();
    // obst√°culos
    ctx.fillStyle = "#1f2937";
    for(const o of obstacles){ ctx.fillRect(o.x,o.y,o.w,o.h); }
    // target
    ctx.beginPath(); ctx.arc(target.x,target.y,target.r+6,0,Math.PI*2); ctx.fillStyle="rgba(16,185,129,.18)"; ctx.fill();
    ctx.beginPath(); ctx.arc(target.x,target.y,target.r,0,Math.PI*2); ctx.fillStyle=varOk(); ctx.fill();
    // start
    ctx.beginPath(); ctx.arc(startPos.x,startPos.y,8,0,Math.PI*2); ctx.fillStyle=varBlue(); ctx.fill();
    // trails
    ctx.save(); ctx.globalCompositeOperation='lighter';
    for(const a of pop){ if(a.trail.length>1){ ctx.beginPath(); for(let i=0;i<a.trail.length;i++){const p=a.trail[i]; if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);} ctx.strokeStyle=a.color; ctx.lineWidth=1; ctx.stroke(); }}
    ctx.restore();
    // agentes
    for(const a of pop){ ctx.beginPath(); ctx.arc(a.x,a.y,3,0,Math.PI*2); ctx.fillStyle=a.reached?varOk():a.alive?a.color:'#64748b'; ctx.fill(); }
    // stats
    statsEl.textContent = `Gen ${generation} ¬∑ Paso ${stepIndex} / ${geneSteps} ¬∑ Llegaron ${reachedCount} ¬∑ Mejor ${formatBestDist(bestDist)}`;
  }

  function varOk(){return getComputedStyle(document.documentElement).getPropertyValue('--ok').trim()||'#10b981'}
  function varBlue(){return getComputedStyle(document.documentElement).getPropertyValue('--blue').trim()||'#3b82f6'}

  // ======= Interacci√≥n =======
  function getPos(ev){ const r=canvas.getBoundingClientRect(); return {x:ev.clientX-r.left, y:ev.clientY-r.top} }
  canvas.addEventListener('mousedown', (ev)=>{
    const p=getPos(ev); const d2=(p.x-target.x)**2+(p.y-target.y)**2;
    if(d2 <= (target.r+12)**2){ target.dragging=true; return; }
    if(ev.shiftKey){ drawing.drawing=true; drawing.x0=p.x; drawing.y0=p.y; }
    if(ev.altKey){ obstacles = obstacles.filter(o=>!(p.x>=o.x && p.x<=o.x+o.w && p.y>=o.y && p.y<=o.y+o.h)); }
  });
  window.addEventListener('mousemove', (ev)=>{
    const p=getPos(ev); if(target.dragging){ target.x=p.x; target.y=p.y; }
  });
  window.addEventListener('mouseup', (ev)=>{
    const p=getPos(ev); if(target.dragging){ target.dragging=false; return; }
    if(drawing.drawing){ const rect=normalizeRect(drawing.x0,drawing.y0,p.x,p.y); if(rect.w>6 && rect.h>6) obstacles.push(rect); drawing.drawing=false; }
  });
  function normalizeRect(x0,y0,x1,y1){ const x=Math.min(x0,x1), y=Math.min(y0,y1); const w=Math.abs(x1-x0), h=Math.abs(y1-y0); return {x,y,w,h}; }

  // ======= Controles =======
  document.getElementById('btn-toggle').addEventListener('click',()=>{
    running=!running; document.getElementById('btn-toggle').textContent = running? 'Pausar':'Reanudar';
  });
  document.getElementById('btn-reset').addEventListener('click',()=>{ generation=1; seedPopulation(); });
  document.getElementById('btn-next').addEventListener('click',()=>evolve());

  bindRange('speed', v=>{ speed = v; });
  bindRange('gravity', v=>{ gravity = v; });
  bindRange('populationSize', v=>{ populationSize = v; document.getElementById('lbl-pop').textContent = v; generation=1; seedPopulation(); });
  bindRange('geneSteps', v=>{ geneSteps = v; document.getElementById('lbl-steps').textContent = v; generation=1; seedPopulation(); });
  bindRange('mutationRate', v=>{ mutationRate = v; document.getElementById('lbl-mutation').textContent = (+v).toFixed(3); });
  bindRange('elitism', v=>{ elitism = v; document.getElementById('lbl-elitism').textContent = v; });

  document.getElementById('btn-obs-clear').addEventListener('click',()=>{ obstacles=[]; });
  document.getElementById('btn-obs-rand').addEventListener('click',()=>{ obstacles = makeRandomObstacles(); });

  function bindRange(id, on){ const el=document.getElementById(id); const parse=el.step && el.step.indexOf('.')>-1 ? parseFloat : v=>parseInt(v,10); el.addEventListener('input',()=>on(parse(el.value))); }

  function makeRandomObstacles(){
    const W=canvas.clientWidth, H=canvas.clientHeight; const n=Math.floor(2+Math.random()*5); const arr=[];
    for(let i=0;i<n;i++){ const w=80+Math.random()*240; const h=8+Math.random()*16; const x=80+Math.random()*(W-160-w); const y=80+Math.random()*(H-160-h); arr.push({x,y,w,h}); }
    return arr;
  }

  // ======= Tests m√≠nimos =======
  (function runTests(){
    console.group('%cTests','color:#22c55e');
    console.assert(formatBestDist(Infinity)==='‚àû','formatBestDist(Infinity) debe ser "‚àû"');
    console.assert(safeFmt(1,3)==='1.000','safeFmt(1,3)');
    console.assert(safeFmt(undefined)==='‚Äî','safeFmt(undefined)');
    console.assert(safeFmt(NaN)==='‚Äî','safeFmt(NaN)');
    // Mutaci√≥n no debe crear vectores con magnitud > 1
    const g=createGenome(32); mutateGenome(g,1,10); const ok=g.every(v=>Math.hypot(v.ax,v.ay)<=1+1e-9); console.assert(ok,'mutateGenome mantiene |v|<=1');
    console.groupEnd();
  })();

  // ======= Boot =======
  // Kickstart con doble intento por si el layout tarda
  seedPopulation();
  resize();
  setTimeout(() => { if(!canvas.clientWidth || !canvas.clientHeight){ resize(); } }, 60);
  loop();
  </script>
</body>
</html>
